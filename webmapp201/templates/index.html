<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Webmapp 201</title>

        <link rel="stylesheet" href="{{ url_for('static', filename='src/leaflet.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='src/css/bootstrap.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='src/plugins/L.Control.Zoomslider.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='src/plugins/L.Control.Sidebar.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='src/plugins/Leaflet.PolylineMeasure.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='src/plugins/Control.Coordinates.css') }}">
        
        <link rel="stylesheet" href="{{ url_for('static', filename='dist/MarkerCluster.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='dist/MarkerCluster.Default.css') }}">
     
         
        <script src="{{ url_for('static', filename='src/leaflet-src.js') }}"></script>
        <script src="{{ url_for('static', filename='src/jquery-3.6.0.min.js') }}"></script>
        <script src="{{ url_for('static', filename='dist/leaflet.markercluster-src.js') }}"></script>
        <script src="{{ url_for('static', filename='src/turf.min.js') }}" charset="utf-8"></script>
        <script src="{{ url_for('static', filename='src/plugins/L.Control.Zoomslider.js') }}"></script>
        <script src="{{ url_for('static', filename='src/plugins/L.Control.Sidebar.js') }}"></script>
        <script src="{{ url_for('static', filename='src/plugins/Leaflet.PolylineMeasure.js') }}"></script>
        <script src="{{ url_for('static', filename='src/plugins/Control.Coordinates.js') }}"></script>

        <script src="{{ url_for('static', filename='swedish_counties.js') }}"></script>
        <script src="{{ url_for('static', filename='countries.js') }}"></script>
        <script src="{{ url_for('static', filename='fuel.js') }}"></script>
        <script src="{{ url_for('static', filename='supermarket.js') }}"></script>
       
        <style>
            #mapdiv {
                height: 100vh;
            }  
            
            #side-bar {
			position: absolute;
			z-index: 1000;
			background: rgba(255,255,255,0.7);
			padding: 10px;
			right: 0;
            top: 0;
			margin: 10px;
			border-radius: 10px;
			min-height: 200px;
            }
                        
        </style>
    </head>
    <body>
       <div id="mapdiv" class="col-md-9"></div>
        <!-- BUTTONS -->
       <div id="side-bar" class="col-md-3"><h2>My Map</h2>
            <button id="l1">layer1</button>
            <button id="l2">layer2</button>
            <button id="btnSater" class="btn btn-primary btn-block">ZoomToS√§ter</button>
            <button id="btnSaterAsenvagen" class="btn btn-primary btn-block">ZoomTo√Ösenv√§gen</button>
            <button id="btnBagarn" class="btn btn-primary btn-block">ZoomToBagarn</button>
            <button id="btnGlobe" class="btn btn-primary btn-block">ZoomToGl√∂ben</button>
       </div>
       <!-- END BUTTONS -->
       
       <!-- SIDEBAR -->
       <div id="sidebar"><h1>Information</h1>
       </div>
       <!-- END SIDEBAR -->
        
       <script>
            var mymap; 
            var lyrOSM; 
            var mrkCurrentLocation;
            var ctlZoomslider;
            var swedishlayer = L.geoJson(swedish_counties);
            var countrieslayer
            var ctlSlidebar;
            var sample = L.geoJson(sample);
            var sample1 = L.geoJson(sample1);
            
           
            $(document).ready(function(){
                mymap = L.map("mapdiv", {center:[60.34640783388847, 15.746372005989052], zoom:13});
                lyrOSM= L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
                mymap.addLayer(lyrOSM);
                
                ctlZoomslider = L.control.zoomslider({position:"topright"}).addTo(mymap);

                const controlCoords = new L.Control.Coordinates();
                controlCoords.addTo(mymap);

                mymap.on('click', function(e) {
                    controlCoords.setCoordinates(e);
                });
                
                var sidebar = L.control.sidebar("sidebar", {position: "left"});
                mymap.addControl(sidebar);
                
                // ICONS

                var iconUrls = {
                    blackIcon: "{{ url_for('static', filename='map-marker.svg') }}",
                    pumpIcon: "{{ url_for('static', filename='pump.svg') }}",
                    cloudIcon: "{{ url_for('static', filename='cloud.svg') }}"
                };   
                            
                var blackIcon = L.icon({
                    iconUrl: iconUrls.blackIcon,
                    iconSize:     [32, 37], 
                    iconAnchor:   [32, 37], 
                    popupAnchor:  [0, -30] 
                });

                var pumpIcon = L.icon({
                    iconUrl: iconUrls.pumpIcon,
                    iconSize:     [32, 37], 
                    iconAnchor:   [32, 37],
                    popupAnchor:  [0, -30] 
                });

                var cloudIcon = L.icon({
                    iconUrl: iconUrls.cloudIcon,
                    iconSize:     [32, 37], 
                    iconAnchor:   [32, 37], 
                    popupAnchor:  [0, -30] 
                });

                // END ICONS
                // MARKERS

                const popSater = L.marker([60.34640783388847, 15.746372005989052],{icon: blackIcon}).addTo(mymap).bindPopup("S√§ter").bindPopup("<h3>Welcome to S√§ter!</h3><img src={{ url_for('static', filename='img/Tokig_i_sater.gif') }} width='150px'>");
                
                
                const popMentalvardMuseum = L.marker([60.34219053393169, 15.711821630690526],{icon: blackIcon}).addTo(mymap);
                popMentalvardMuseum.on('click', function(e){
                    sidebar.show();
                    sidebar.setContent("<h3>Welcome to Mentalv√•rdsmuseet!</h3><p>Mentalv√•rdsmuseet √§r bel√§get vid S√§ters sjukhus och ber√§ttar om den tid d√• st√∂rsta delen av psykiatrins verksamhet bedrevs p√• stora mentalsjukhus. Den h√§r webbplatsen riktar sig till dig som vill bes√∂ka oss eller veta mer om museets historia och samlingar.<p><img src={{ url_for('static', filename='img/mentalvardmuseumsater.jpg') }} width='150px'>");
                });
                
                const popSaterGrillen = L.marker([60.34709575205177, 15.75163681099822],{icon: blackIcon}).addTo(mymap);
                popSaterGrillen.on('click', function(e) {
                    sidebar.show();
                    sidebar.setContent("<h3>Welcome to S√§ter Grillen!</h3><p>Upplev gourmetniv√• med v√•r signatur Mexikanska pizza! Utforska smakens m√•ngfaldüòâüçïüå∂Ô∏è Varning: kan orsaka beroende av kryddig godhet! üòã<p><img src={{ url_for('static', filename='img/pizzeria.jpg') }} width='150px'>");
                });
                
                const popKlockarSkolan = L.marker([60.346646945534005, 15.740775937986164],{icon: blackIcon}).addTo(mymap);
                popKlockarSkolan.on('click', function(e) {
                    sidebar.show();
                    sidebar.setContent("<h3>Welcome to Klockarskolan!</h3><p>Det h√§r √§r Klockarskolan - S√§ters kommuns skola f√∂r elever i √•rskurs 7-9. F√∂r oss √§r det viktigt att DU upplever att du LYCKAS med ditt skolarbete och att vi hj√§lps √•t.<p><img src={{ url_for('static', filename='img/klockarskolan.png') }} width='150px'>");
                });

                const popSaterDalen = L.marker([60.350030240931474, 15.759631888742012],{icon: blackIcon}).addTo(mymap);
                popSaterDalen.on('click', function(e) {
                    sidebar.show();
                    sidebar.setContent("<h3>Welcome to S√§terdalen!</h3><p>S√§terdalen √§r ett omv√§xlande landskap med branta raviner och b√∂ljande skogsbackar. P√• ravinens botten slingrar sig Ljuster√•n fram. En vandringsled g√•r genom dalen l√§ngs med Ljuster√•ns str√§nder. H√§r finns en unik och fantastiskt vacker natur, men √§ven en kunglig rastplats!<p><img src={{ url_for('static', filename='img/saterdalen.png') }} width='150px'>");
                });
             
                const popSaterKyrka = L.marker([60.345466899686755, 15.746454147785553],{icon: blackIcon}).addTo(mymap);
                popSaterKyrka.on('click', function(e) {
                    sidebar.show();
                    sidebar.setContent("<h3>Welcome to S√§ters kyrka!</h3><p>S√§ters kyrka i S√§ter √§r f√∂rsamlingskyrka f√∂r S√§terbygdens f√∂rsamling i V√§ster√•s stift. Den nuvarande kyrkan byggdes 1778‚Äì1779. Tornet byttes dock ut 1806‚Äì1807, d√• det stod p√• ostadig grund. 1811 fastst√§lldes hur orgelfasaden och altaret skulle se ut.<br><br>Tidigare stod en annan stenkyrka p√• platsen. Den invigdes p√• h√∂sten 1635 och ersatte d√• en tr√§kyrka som var i bruk 1628‚Äì1635. Det visade sig dock att denna kyrka var underm√•ligt byggd och man rev den √•r 1778. <br><br> I anslutning till kyrkan, p√• andra sidan gatan, ligger f√∂rsamlingshemmet Corianderg√•rden. Denna har f√•tt sitt namn av S√§ters f√∂rsta kyrkoherde Magnus Andr√¶ Coriander, verksam 1636‚Äì1663, vilken √§ven har gett namn √•t kyrkok√∂ren Corianderk√∂ren. <p><img src={{ url_for('static', filename='img/saterskyrka.png') }} width='150px'>");
                });

                // END MARKERS
                // CLICK FUNCTION TO HIDE SIDEBAR

                mymap.on('click', function() {
                    sidebar.hide();
                });
                
                // END CLICK FUNCTION TO HIDE SIDEBAR

                // POLYLINE MEASURE LINES

                let polyLine = L.control.polylineMeasure({showBearings:true, clearMeasurementsOnStop: false, showUnitControl: true}).addTo(mymap);

                const saterLines = [
                    {lat: 60.34219053393169, lng:15.711821630690526},
                    {lat: 60.346646945534005, lng: 15.740775937986164},
                    {lat: 60.350030240931474, lng: 15.759631888742012},
                    {lat: 60.34709575205177, lng: 15.75163681099822},
                    {lat: 60.345466899686755, lng: 15.746454147785553},
                    {lat: 60.34219053393169, lng:15.711821630690526}
                ];

                polyLine.seed([saterLines]);

                // END POLYLINE MEASURE LINES
                // POLYGON
                    
                const gustafsBrodPoly = L.polygon([
                    [60.40405873387609, 15.596026646989579],
                    [60.40418349349315, 15.596434885259788],
                    [60.40433498667086, 15.59616874097313],
                    [60.404436353035635, 15.595859742945398],
                    [60.404242531359486, 15.595568788598122] 
                ]).addTo(mymap).bindPopup("Gustafs br√∂d").bindPopup("<h3>Gustafs br√∂d</h3><img src={{ url_for('static', filename='/img/gustafs_brod.png') }} width='150px'>");

                // END POLYGON
                // POLYLINE

                const asenvag_points =  [
                    [60.338360351490955, 15.7607417838101],
                    [60.338609894903215, 15.760586215682807],
                    [60.338795723864074, 15.760366274537317],
                    [60.34059820989227, 15.75711543699507],
                    [60.340717664209045, 15.756777478649568],
                    [60.34087428142849, 15.75619275706766]
                ];

                const asenVagLine = L.polyline(asenvag_points, { color: 'red'}).addTo(mymap).bindPopup("√Ösen v√§gen").bindPopup("<h3>√Ösen v√§gen</h3><img src={{ url_for('static', filename='/src/images/skogsvag.jpg') }} width='150px'>");

                // END POLYLINE
                // VIJAYS SWEDEN LAYER

                document.getElementById("l1").addEventListener("click", sweden);

                function sweden(){
                    if(mymap.hasLayer(swedishlayer)){
                        mymap.removeLayer(swedishlayer);
                        
                        sidebar.hide();
                        
                    } else {
                        swedishlayer.addTo(mymap);
                        
                        sidebar.show();
                    }
                    
                };

                // END VIJAYS SWEDEN LAYER
                // VIJAYS COUNTRIES LAYER
 
                countrieslayer = L.geoJson(countries, {
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(feature.properties.name);
			            }
		        });

		        document.getElementById("l2").addEventListener("click", c_layers);
                
                function c_layers(){
                    if(mymap.hasLayer(countrieslayer)){
                        mymap.removeLayer(countrieslayer);
                    } 
                    else {
                        countrieslayer.addTo(mymap);
                    }
                };
                
                // END VIJAYS COUNTRIES LAYER
                // SUPERMARKET FUNCTIONS

                const supermarketBuffers = [];
                
                const supermarketLayer = L.geoJson(supermarket, {
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(feature.properties.name).addTo(mymap);
                        const buffer = turf.buffer(feature, 1, {units: 'kilometers'});
                     
                        let bufferLayer = L.geoJSON(buffer, {
                            style:{
                                color:'orange', 
                                dashArray:'10', 
                                fillOpacity:0.3
                            }
                        }).addTo(mymap);

                        supermarketBuffers.push({
                            feature: feature,
                            layer: layer,
                            buffer: buffer,
                            bufferLayer: bufferLayer
                        })

                        layer.addTo(mymap); 
                    }
                    
                });

                supermarketBuffers.forEach((supermarket, index) => {
                    let overlaps = false;
                    supermarketBuffers.forEach((otherSupermarket, otherIndex) => {
                        if (index !== otherIndex && turf.intersect(supermarket.buffer, otherSupermarket.buffer)) {
                            overlaps = true;
                        }   
                    });

                    if (!overlaps) {
                        supermarket.bufferLayer.setStyle({
                            color: 'purple',
                            fillColor: 'purple',
                            fillOpacity: 0.3
                        });
                        supermarket.layer.bindPopup(supermarket.feature.properties.name + " - Not overlapping"); 
                    }   
                });
                
                // END SUPERMARKET FUNCTIONS
                // BUTTON CLICK FUNCTIONS

                // IMAGE OVERLAY

                const globenBounds = L.latLngBounds([
                    [59.2940,  18.0823], 
                    [59.2932,  18.0841]
                ]);

                const imageOverlayGloben = L.imageOverlay("{{url_for('static', filename='/img/GLOBEN.png')}}", globenBounds, {
                    opacity: 0.8,
                    //errorOverlayUrl: errorOverlayUrl,
                    alt: 'Globen',
                    interactive: true
                }).addTo(mymap);

                // Add ‚Äúfuel.geoJSON‚Äù file to the map. 
                // Then add ‚ÄúLeaflet.markercluster‚Äù plugin to your web application and display the data from fuel.geoJSON.
                // Display name of the fuel station when clicked on the marker.

                //const fuelLayer = L.markerClusterGroup(fuelStations);
                //fuelLayer.addLayer(L.marker(getRandomLatLng(mymap)));
                //mymap.addLayer(fuelLayer)

                // fuelLayer = L.geoJson(fuel, {
                //     onEachFeature: function (feature, layer) {
                //         layer.bindPopup(feature.properties.name);
                //         const fuelLayer = L.markerClusterGroup(fuel);
                //         fuelLayer.addLayer(L.marker(getRandomLatLng(mymap)));
                //         mymap.addLayer(fuelLayer) 
			    //         }
		        // });

                const fuelLayer = L.markerClusterGroup();

                L.geoJson(fuel, {
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup(feature.properties.name);
                        }
                    },
                    pointToLayer: function (feature, latlng) {

                        return L.marker(latlng, {icon: pumpIcon});
                    }
                }).addTo(fuelLayer);

                mymap.addLayer(fuelLayer);

                var cities = [
                    { name: "Falun", coords: [60.60580472861724, 15.63369720593686] },
                    { name: "Borl√§nge", coords: [60.48368089294031, 15.430147102186696] },
                    { name: "Gagnef", coords: [60.59086617909959, 15.07043173564424] },
                    { name: "Hedemora", coords: [60.27764295995458, 15.985137188118204] },
                    { name: "Avesta", coords: [60.145258163689, 16.172561789224062] }
                ];

                const apiKey = '348f0c4a77d2eebd3718ea3136e113a4';

                cities.forEach(city => {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${city.coords[0]}&lon=${city.coords[1]}&appid=${apiKey}&units=metric`;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => { 
                            const temp = data.main.temp;
                            const desc = data.weather[0].description;
                            const iconCode = data.weather[0].icon;
                            const iconUrl = `http://openweathermap.org/img/w/${iconCode}.png`;
                            const marker = L.marker(city.coords, {icon: cloudIcon}).addTo(mymap);
                            marker.bindPopup(`<h3>${city.name}</h3><p>Temperature: ${temp}¬∞C<br>Description: ${desc}</p><img src="${iconUrl}">`);
                        });
                }); s

                // setView max 18
                $("#btnSater").click(function(){
                    mymap.setView([60.34640783388847, 15.746372005989052], 15);
                })

                $("#btnSaterAsenvagen").click(function(){
                    mymap.setView([60.338795723864074, 15.760366274537317], 17);
                })

                $("#btnBagarn").click(function(){
                    mymap.setView([60.40433498667086, 15.59616874097313], 18);
                })

                $("#btnGlobe").click(function(){
                    mymap.setView([59.29356499477762, 18.083123473195176], 18);
                })

                // END BUTTON CLICK FUNCTIONS            
            });            
       </script>
    </body>
</html>